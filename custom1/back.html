{{FrontSide}}
<div class="math-card">
  
  <div class="solution-section">
    
    <div class="answer-box" style="font-weight: normal;">
      <div class="section-title" style="margin: 4px 0;">最终答案</div>
      <div class="math-content">{{Answer}}</div>
    </div>
    
    <!-- 修复步骤显示 -->
    <div class="steps-container">
      <div class="section-title">解题步骤</div>
      <div id="stepsContent"></div>
    </div>
    
    {{#KeyConcept}}
    <div class="concept-box">
      <div class="section-title" style="margin: 4px 0;">核心概念</div>
      <div class="math-content">{{KeyConcept}}</div>
    </div>
    {{/KeyConcept}}
    
    {{#Formula}}
    <div class="formula-box">
      <div class="section-title" style="margin: 4px 0;">关键公式</div>
      <div class="math-content">{{Formula}}</div>
    </div>
    {{/Formula}}
    
    {{#CommonMistakes}}
    <div class="mistake-box">
      <div class="section-title" style="margin: 4px 0;">易错警示</div>
      <ul class="mistake-list" id="mistakesList"></ul>
    </div>
    {{/CommonMistakes}}
  </div>
</div>

<script>
// 步骤处理函数
function processSteps() {
  const stepsContent = document.getElementById('stepsContent');
  if (!stepsContent) return;
  
  const stepsData = "{{Steps}}";
  if (!stepsData) return;
  
  const steps = stepsData.split("||");
  stepsContent.innerHTML = '';
  
  steps.forEach((step, index) => {
    const stepElement = document.createElement('div');
    stepElement.className = 'step';
    stepElement.innerHTML = `
      <div class="step-header" onclick="toggleStep(this)">
        <span class="step-number">${index + 1}</span>
        <span class="toggle-icon">▼</span>
      </div>
      <div class="step-content">
        <div class="math-content">${step}</div>
      </div>
    `;
    stepsContent.appendChild(stepElement);
  });
}

// 易错点处理
function processMistakes() {
  const mistakesList = document.getElementById('mistakesList');
  if (!mistakesList) return;
  
  const mistakesData = "{{CommonMistakes}}";
  if (!mistakesData) return;
  
  const mistakes = mistakesData.split("|");
  mistakesList.innerHTML = '';
  
  mistakes.forEach(mistake => {
    if (mistake.trim()) {
      const li = document.createElement('li');
      li.textContent = mistake;
      mistakesList.appendChild(li);
    }
  });
}

// 步骤折叠功能
function toggleStep(header) {
  const content = header.nextElementSibling;
  const icon = header.querySelector('.toggle-icon');
  
  if (content.style.display === 'none' || !content.style.display) {
    content.style.display = 'block';
    icon.textContent = '▲';
  } else {
    content.style.display = 'none';
    icon.textContent = '▼';
  }
}

// 应用设置函数
function applySettings() {
  // 从localStorage加载设置
  let frontSettings = window.frontSettings;
  if (!frontSettings) {
    try {
      const savedSettings = localStorage.getItem('ankiCardSettings');
      if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        frontSettings = {
          fontSize: parsed.fontSize || 16,
          lineHeight: parsed.lineHeight || 1.5,
        };
      } else {
        frontSettings = { fontSize: 16, lineHeight: 1.5 };
      }
    } catch (e) {
      console.warn('无法从localStorage加载设置:', e);
      frontSettings = { fontSize: 16, lineHeight: 1.5 };
    }
  }
  
  document.documentElement.style.setProperty('--base-font-size', `${frontSettings.fontSize}px`);
  document.documentElement.style.setProperty('--line-height', frontSettings.lineHeight);
}

// 初始化函数
function initBack() {
  // 处理内容
  processSteps();
  processMistakes();
  
  // 折叠所有步骤
  document.querySelectorAll('.step-content').forEach(content => {
    content.style.display = 'none';
  });
  
  // 应用设置
  applySettings();
  
  // 渲染数学公式
  MathJax.typesetPromise().catch(console.error);
}

// 执行初始化
setTimeout(initBack, 50);
</script>