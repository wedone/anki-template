{{FrontSide}}
<div class="math-card">
  
  <div class="solution-section">
    
    <div class="answer-box" style="font-weight: normal;">
      <div class="section-title" style="margin: 4px 0;">最终答案</div>
      <div class="math-content" id="answerContent">{{Answer}}</div>
    </div>
    
    <!-- 修复步骤显示 -->
    <div class="steps-container" id="stepsContainer">
      <div class="section-title">解题步骤</div>
      <div id="stepsContent"></div>
    </div>
    
    {{#KeyConcept}}
    <div class="concept-box">
      <div class="section-title" style="margin: 4px 0;">核心概念</div>
      <div class="math-content">{{KeyConcept}}</div>
    </div>
    {{/KeyConcept}}
    
    {{#Formula}}
    <div class="formula-box">
      <div class="section-title" style="margin: 4px 0;">关键公式</div>
      <div class="math-content">{{Formula}}</div>
    </div>
    {{/Formula}}
    
    {{#CommonMistakes}}
    <div class="mistake-box">
      <div class="section-title" style="margin: 4px 0;">易错警示</div>
      <ul class="mistake-list" id="mistakesList"></ul>
    </div>
    {{/CommonMistakes}}
  </div>
</div>

<script>
// 检查字段是否为空的函数
function isEmptyField(fieldContent) {
  return !fieldContent || fieldContent.trim() === '';
}

// 答案处理函数
function processAnswer() {
  const answerContent = document.getElementById('answerContent');
  const answerBox = answerContent?.closest('.answer-box');
  
  if (!answerContent || !answerBox) return;
  
  const answerData = "{{Answer}}";
  
  // 如果答案为空，隐藏整个答案容器
  if (isEmptyField(answerData)) {
    answerBox.style.display = 'none';
  } else {
    answerBox.style.display = 'block';
  }
}

// 步骤处理函数
function processSteps() {
  const stepsContent = document.getElementById('stepsContent');
  const stepsContainer = document.getElementById('stepsContainer');
  
  if (!stepsContent || !stepsContainer) return;
  
  const stepsData = "{{Steps}}";
  
  // 如果步骤为空，隐藏整个步骤容器
  if (isEmptyField(stepsData)) {
    stepsContainer.style.display = 'none';
    return;
  }
  
  // 显示步骤容器
  stepsContainer.style.display = 'block';
  
  const steps = stepsData.split("||");
  stepsContent.innerHTML = '';
  
  steps.forEach((step, index) => {
    const stepElement = document.createElement('div');
    stepElement.className = 'step';
    stepElement.innerHTML = `
      <div class="step-header">
      </div>
      <div class="step-content">
        <div class="math-content">${step}</div>
      </div>
    `;
    stepsContent.appendChild(stepElement);
  });
}

// 易错点处理
function processMistakes() {
  const mistakesList = document.getElementById('mistakesList');
  const mistakeBox = mistakesList?.closest('.mistake-box');
  
  if (!mistakesList || !mistakeBox) return;
  
  const mistakesData = "{{CommonMistakes}}";
  
  // 如果易错点为空，隐藏整个易错点容器
  if (isEmptyField(mistakesData)) {
    mistakeBox.style.display = 'none';
    return;
  }
  
  // 显示易错点容器
  mistakeBox.style.display = 'block';
  
  const mistakes = mistakesData.split("|");
  mistakesList.innerHTML = '';
  
  mistakes.forEach(mistake => {
    if (mistake.trim()) {
      const li = document.createElement('li');
      li.textContent = mistake;
      mistakesList.appendChild(li);
    }
  });
}

// 应用设置函数
function applySettings() {
  // 从localStorage加载设置
  let frontSettings = window.frontSettings;
  if (!frontSettings) {
    try {
      const savedSettings = localStorage.getItem('ankiCardSettings');
      if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        frontSettings = {
          fontSize: parsed.fontSize || 16,
          lineHeight: parsed.lineHeight || 1.5,
        };
      } else {
        frontSettings = { fontSize: 16, lineHeight: 1.5 };
      }
    } catch (e) {
      console.warn('无法从localStorage加载设置:', e);
      frontSettings = { fontSize: 16, lineHeight: 1.5 };
    }
  }
  
  document.documentElement.style.setProperty('--base-font-size', `${frontSettings.fontSize}px`);
  document.documentElement.style.setProperty('--line-height', frontSettings.lineHeight);
}

// 初始化函数
function initBack() {
  // 处理内容
  processAnswer();
  processSteps();
  processMistakes();
  
  // 应用设置
  applySettings();
  
  // 渲染数学公式
  MathJax.typesetPromise().catch(console.error);
}

// 执行初始化
setTimeout(initBack, 50);
</script>