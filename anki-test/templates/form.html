<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Anki 数学问答模板预览</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { background: #f5f6fa; }
    .form-title { text-align: center; font-size: 30px; font-weight: bold; color: #2980b9; margin-bottom: 20px; }
    .main-flex {
      display: flex;
      max-width: 100%;
      margin: 30px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0001;
      min-height: 700px;
      overflow-x: hidden;
    }
    .form-panel { flex: 0 0 40%; min-width: 0; border-right: 1px solid #eee; padding: 32px 24px 24px 24px; background: #fafbfc; }
    .preview-panel-group { flex: 1 1 0; min-width: 0; display: flex; flex-direction: column; align-items: stretch; }
    .preview-toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 18px; }
    .preview-panel {
      flex: 0 0 60%;
      min-width: 0;
      padding: 32px 32px 24px 32px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .btn-group { display: flex; gap: 12px; margin-bottom: 18px; justify-content: flex-start; align-items: center; }
    .side-btn { background: #eee; color: #2980b9; border: 1px solid #bcd; border-radius: 4px; padding: 6px 18px; font-size: 16px; margin-right: 0; cursor: pointer; transition: background 0.2s, color 0.2s; }
    .side-btn.active, .side-btn:active { background: #3498db; color: #fff; border-color: #2980b9; }
    .side-btn:not(.active):hover { background: #e3f2fd; }
    .btn { background: #3498db; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; margin-right: 8px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #2980b9; }
    .preview-mode-btn { background: #eee; color: #2980b9; border: 1px solid #bcd; border-radius: 4px; padding: 6px 18px; font-size: 16px; cursor: pointer; transition: background 0.2s, color 0.2s; }
    .preview-mode-btn.active, .preview-mode-btn:active { background: #3498db; color: #fff; border-color: #2980b9; }
    .preview-mode-btn:not(.active):hover { background: #e3f2fd; }
    .preview-frame {
      width: 100%;
      max-width: 100%;
      min-height: 1500px;
      padding: 10px 10px 24px 10px; 
      border: 1px solid #eee;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 2px 8px #0001;
      transition: width 0.3s, margin 0.3s, box-shadow 0.3s, border-radius 0.3s;
      display: block;
      box-sizing: border-box;
    }
    .preview-frame.mobile {
      width: 500px;
      min-width: 340px;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 16px;
      box-shadow: 0 0 0 6px #2222, 0 2px 16px #0002;
      border: 1px solid #bbb;
    }
    .preview-panel.mobile {
      align-items: flex-start;
    }
    /* 字段列表交互样式 */
    .field-list { list-style: none; padding: 0; margin: 0; }
    .field-item { border-bottom: 1px solid #eee; padding: 0; }
    .field-header { display: flex; align-items: center; cursor: pointer; padding: 8px 0; transition: background 0.2s; }
    .field-header:hover { background: #e3f2fd; }
    .field-label { flex: 0 0 100px; color: #2980b9; font-weight: bold; }
    .field-status { flex: 1; color: #888; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .field-dot { width: 8px; height: 8px; border-radius: 50%; background: #4caf50; display: inline-block; margin-right: 8px; }
    .field-item.filled .field-label { color: #4caf50; }
    .field-item.filled .field-status { color: #333; }
    .field-input-wrap { display: none; padding: 8px 0 12px 0; }
    .field-item.active .field-input-wrap { display: block; }
    .field-item.active .field-header { background: #e3f2fd; }
    textarea { width: 100%; min-height: 36px; font-size: 15px; border-radius: 4px; border: 1px solid #ccc; padding: 4px 8px; }
    .field-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 18px; }
    .field-btn { background: #f5f6fa; border: 1px solid #bcd; border-radius: 6px; padding: 10px 6px; font-size: 15px; color: #2980b9; cursor: pointer; transition: background 0.2s, color 0.2s, border 0.2s; text-align: center; min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .field-btn.filled { color: #4caf50; border-color: #4caf50; font-weight: bold; }
    .field-btn.active { background: #e3f2fd; border-color: #3498db; color: #3498db; }
    .field-input-float {
      position: absolute;
      z-index: 100;
      background: #fff;
      border: 1.5px solid #3498db;
      border-radius: 12px;
      box-shadow: 0 8px 36px #0002;
      padding: 32px 0 28px 0;
      min-width: 520px;
      max-width: 640px;
      min-height: 220px;
      display: none;
      transition: box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .field-input-float label {
      font-weight: bold;
      color: #2980b9;
      margin-bottom: 18px;
      display: block;
      font-size: 22px;
      text-align: center;
    }
    .field-input-float textarea {
      width: 96%;
      min-height: 220px;
      font-size: 18px;
      border-radius: 8px;
      border: 1.5px solid #3498db;
      background: #fafdff;
      padding: 20px 18px;
      margin-bottom: 12px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
      resize: vertical;
      color: #222;
    }
    .field-input-float .close-btn {
      position: absolute;
      top: 14px;
      right: 22px;
      background: none;
      border: none;
      font-size: 26px;
      color: #3498db;
      cursor: pointer;
    }
    .btn-group, .field-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 18px;
    }
    .btn, .side-btn, .field-btn {
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      margin: 0;
    }
    .preview-toolbar {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 18px;
    }
    .preview-mode-btn {
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      margin: 0;
    }
    @media (max-width: 1100px) {
      .main-flex { flex-direction: column; }
      .form-panel, .preview-panel { padding: 18px 8px; }
      .form-panel { border-right: none; border-bottom: 1px solid #eee; }
    }
    .ios-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 26px;
    }
    .ios-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .ios-switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 26px;
    }
    .ios-switch .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 1px 3px #0002;
    }
    .ios-switch input:checked + .slider {
      background-color: #4cd964;
    }
    .ios-switch input:checked + .slider:before {
      transform: translateX(18px);
    }
  </style>
</head>
<body>
  <div class="form-title">Anki 数学问答模板预览</div>
  <div class="main-flex">
    <div class="form-panel">
      <div style="margin-bottom: 12px;">
        <label for="templateSelect" style="font-weight:bold;color:#2980b9;">选择模板：</label>
        <select id="templateSelect"></select>
      </div>
      <form id="ankiForm" method="post" target="previewFrame" autocomplete="off">
        <div class="btn-group">
          <button type="button" class="side-btn" id="frontBtn">正面预览</button>
          <button type="button" class="side-btn" id="backBtn">背面预览</button>
          <button class="btn" type="submit" id="refreshBtn">刷新预览</button>
          <button class="btn" type="button" onclick="clearForm()" style="background:#e74c3c;">清空内容</button>
          <button class="btn" type="button" id="scanFieldsBtn" style="background:#27ae60;">扫描字段</button>
          <button class="btn" type="button" id="saveServerBtn" style="background:#f39c12;">保存数据</button>
        </div>
        <input type="hidden" name="side" id="sideInput" value="front">
        <div class="field-grid" id="fieldGrid"></div>
        <div id="fieldInputFloat" class="field-input-float" style="display:none;"></div>
        <div id="hiddenFields" style="display:none;"></div>
      </form>
    </div>
    <div class="preview-panel-group">
      <div class="preview-panel" id="previewPanel">
        <div style="margin-bottom: 18px; display: flex; align-items: center; gap: 12px; min-width: 120px;">
          <label for="previewToggle" style="font-weight:bold;color:#2980b9;">手机预览</label>
          <label class="ios-switch">
            <input type="checkbox" id="previewToggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="preview-frame-outer" style="padding: 18px 10px 18px 10px; box-sizing: border-box; width: 100%; height: auto;">
          <iframe name="previewFrame" class="preview-frame" id="previewFrame" scrolling="no"></iframe>
        </div>
      </div>
    </div>
  </div>
  <script>
    let currentTemplate = '';
    let currentSide = 'front';
    let currentMode = 'desktop';
    let allFieldData = {};

    async function loadTemplateList() {
      const res = await fetch('/template_list');
      const data = await res.json();
      const select = document.getElementById('templateSelect');
      select.innerHTML = '';
      data.templates.forEach(tpl => {
        const opt = document.createElement('option');
        opt.value = tpl;
        opt.textContent = tpl;
        select.appendChild(opt);
      });
      if (data.templates.length > 0) {
        currentTemplate = data.templates[0];
        select.value = currentTemplate;
      }
    }

    document.getElementById('templateSelect').addEventListener('change', async function() {
      currentTemplate = this.value;
      await renderFields();
      setPreviewSide(currentSide);
    });

    async function renderFields() {
      if (!currentTemplate) return;
      const [fieldsRes, dataRes] = await Promise.all([
        fetch(`/scan_fields?tpl=${currentTemplate}`).then(r => r.json()),
        fetch(`/load_fields?tpl=${currentTemplate}`).then(r => r.json())
      ]);
      const fields = fieldsRes.fields;
      allFieldData = { ...dataRes };
      const fieldGrid = document.getElementById('fieldGrid');
      fieldGrid.innerHTML = '';
      fields.forEach(field => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'field-btn';
        btn.textContent = field;
        btn.dataset.field = field;
        if (allFieldData[field]) btn.classList.add('filled');
        btn.onclick = function(e) { showFieldInput(field, btn); };
        fieldGrid.appendChild(btn);
      });
    }

    function syncFieldsToForm() {
      const hidden = document.getElementById('hiddenFields');
      hidden.innerHTML = '';
      Object.keys(allFieldData).forEach(field => {
        const ta = document.createElement('textarea');
        ta.name = field;
        ta.style.display = 'none';
        ta.value = allFieldData[field];
        hidden.appendChild(ta);
      });
    }

    function setPreviewSide(side) {
      currentSide = side;
      document.getElementById('sideInput').value = side;
      document.getElementById('frontBtn').classList.toggle('active', side === 'front');
      document.getElementById('backBtn').classList.toggle('active', side === 'back');
      document.getElementById('ankiForm').action = `/preview/${side}?tpl=${currentTemplate}`;
      syncFieldsToForm();
      document.getElementById('ankiForm').submit();
    }

    document.getElementById('frontBtn').onclick = function() { setPreviewSide('front'); };
    document.getElementById('backBtn').onclick = function() { setPreviewSide('back'); };
    document.getElementById('refreshBtn').onclick = function(e) {
      e.preventDefault();
      syncFieldsToForm();
      document.getElementById('ankiForm').submit();
    };

    // 预览模式切换
    function setPreviewMode(mode) {
      currentMode = mode;
      const frame = document.getElementById('previewFrame');
      const panel = document.getElementById('previewPanel');
      document.getElementById('previewToggle').checked = (mode === 'mobile');
      if (mode === 'mobile') {
        frame.classList.add('mobile');
        panel.classList.add('mobile');
        resizePreviewFrame();
      } else {
        frame.classList.remove('mobile');
        panel.classList.remove('mobile');
        resizePreviewFrame();
      }
    }
    const previewToggle = document.getElementById('previewToggle');
    function setPreviewModeByToggle() {
      if (previewToggle.checked) {
        setPreviewMode('mobile');
      } else {
        setPreviewMode('desktop');
      }
    }
    previewToggle.addEventListener('change', setPreviewModeByToggle);
    setPreviewMode('mobile');

    // 保存到服务器按钮
    document.getElementById('saveServerBtn').onclick = async function() {
      await fetch(`/save_fields?tpl=${currentTemplate}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(allFieldData)
      });
      alert('已保存到服务器！');
    };
    document.getElementById('scanFieldsBtn').onclick = async function() {
      await renderFields();
    };

    // 悬浮输入框逻辑
    function showFieldInput(field, btn) {
      const floatBox = document.getElementById('fieldInputFloat');
      if (floatBox.style.display === 'block' && floatBox.dataset.field === field) {
        floatBox.style.display = 'none';
        btn.classList.remove('active');
        return;
      }
      document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      floatBox.innerHTML = `
        <button class="close-btn" onclick="hideFieldInput()">×</button>
        <label>${field}</label>
        <textarea id="floatInput" style="resize:vertical;">${allFieldData[field] || ''}</textarea>
      `;
      floatBox.style.display = 'block';
      floatBox.dataset.field = field;
      const rect = btn.getBoundingClientRect();
      const floatWidth = 520;
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      floatBox.style.top = (rect.bottom + scrollTop + 12) + 'px';
      floatBox.style.left = (rect.left + rect.width / 2 - floatWidth / 2 + scrollLeft) + 'px';
      const input = document.getElementById('floatInput');
      input.focus();
      input.oninput = function() {
        allFieldData[field] = input.value;
        btn.classList.toggle('filled', !!input.value.trim());
      };
    }
    function hideFieldInput() {
      const floatBox = document.getElementById('fieldInputFloat');
      floatBox.style.display = 'none';
      document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
    }
    document.addEventListener('mousedown', function(e) {
      const floatBox = document.getElementById('fieldInputFloat');
      if (floatBox.style.display === 'block') {
        if (!floatBox.contains(e.target) && !e.target.classList.contains('field-btn')) {
          hideFieldInput();
        }
      }
    });

    // 让预览 iframe 高度自适应内容
    function resizePreviewFrame() {
      const frame = document.getElementById('previewFrame');
      try {
        if (frame.contentDocument && frame.contentDocument.body) {
          frame.style.height = frame.contentDocument.body.scrollHeight + 'px';
        }
      } catch (e) {}
    }
    document.getElementById('previewFrame').addEventListener('load', resizePreviewFrame);

    // 清空按钮也清除 localStorage
    function clearForm() {
      var t = document.querySelectorAll('.form-panel textarea');
      t.forEach(e => e.value = '');
      allFieldData = {};
      updateFieldStatus();
      setTimeout(() => setPreviewSide(currentSide), 10);
    }

    // 字段输入内容自动保存/恢复（可选：可按模板名区分localStorage）
    // ...如需实现可补充...

    // 字段按钮状态
    function updateFieldStatus() {
      document.querySelectorAll('.field-btn').forEach(function(item) {
        const field = item.getAttribute('data-field');
        const status = item.querySelector('.field-status');
        let val = allFieldData[field] ? allFieldData[field].trim() : '';
        if (val) {
          item.classList.add('filled');
          if (status) status.innerHTML = '<span class="field-dot"></span>' + (val.length > 20 ? val.slice(0, 20) + '...' : val);
        } else {
          item.classList.remove('filled');
          if (status) status.textContent = '未填写';
        }
      });
    }

    // 页面加载时
    window.onload = async function() {
      await loadTemplateList();
      await renderFields();
      setPreviewSide('front');
      updateFieldStatus();
    }
  </script>
</body>
</html> 